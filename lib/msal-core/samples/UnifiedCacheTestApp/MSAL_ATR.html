<!DOCTYPE html>

<html>
    <head>
        <title>Vanilla MSAL.JS</title>
        <meta charset="utf-8" />
        <style type="text/css">body { font-family: Tahoma; padding: 3em; }</style>
        <script src="dist/msal.js" class="pre"></script>
    </head>

    <body>
        <a href=".\">&lt; Back</a>
        <h4>MSAL+ (ATR Only)</h4>
        <p>
            <a id="login_button" href="#" onclick="login(); return false;">Log in</a>
            <a id="logout_button" href="#" onclick="logout(); return false;">Log out</a>
        </p>

        <p id="username"></p>
        <pre id="api_response"></pre>

        <script type="text/javascript">
            document.getElementById('login_button').style.display = "none";
            document.getElementById('logout_button').style.display = "none";

            function loggerCallback(logLevel, message, piiLoggingEnabled) {
                console.log(message);
            }     

            var logger = new Msal.Logger(loggerCallback, { level: Msal.LogLevel.Verbose, correlationId:'12345' }); // level and correlationId are optional parameters.
		
            // Set up MSAL
            var applicationConfig = {
                clientID: '6c8c7103-4a23-4034-ae6b-b42f0438a232',
                graphEndpoint: "https://graph.microsoft.com/v1.0/me/sendMail",
                graphScopes: ["user.read", "mail.send"],
                authority: "https://login.microsoftonline.com/microsoft.onmicrosoft.com/",
                logger: logger
            };

            var clientApplication = new Msal.UserAgentApplication(applicationConfig.clientID, applicationConfig.authority, authCallback);

            function authCallback(errorDesc, token, error, tokenType) {
                //This function is called after loginRedirect and acquireTokenRedirect. Use tokenType to determine context. 
                //For loginRedirect, tokenType = "id_token". For acquireTokenRedirect, tokenType:"access_token".
                if (token) {
                    this.acquireTokenSilent(applicationConfig.graphScopes).then(function (access_token) {
                        // Change button to Sign Out
                        document.getElementById('api_response').textContent = 'Calling API...';

                        var xhr = new XMLHttpRequest();

                        xhr.open('GET', 'https://graph.microsoft.com/v1.0/me', true);
                        xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);

                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                document.getElementById('api_response').textContent = JSON.stringify(JSON.parse(xhr.responseText), null, '  ');
                            } else {
                                document.getElementById('api_response').textContent = 'ERROR:\n\n' + xhr.responseText;
                            }
                        };

                        xhr.send();
                    }, function (error) {
                        console.log(error);
                        this.acquireTokenPopup(applicationConfig.graphScopes).then(function (access_token) {

                        }, function (error) {
                            console.log(error);
                        });
                    });
                }
                else if (errorDesc || error) {
                    console.log(error + ':' + errorDesc);
                }
            }

            function login() {
                clientApplication.loginRedirect(applicationConfig.graphScopes);
            }

            function logout() {
                if (clientApplication) {
                    clientApplication.logout();
                }
            }

            document.getElementById('username').textContent = 'Loading...'; 

            document.getElementById('api_response').textContent = 'Calling Graph API...'; 
            clientApplication.acquireTokenSilent(applicationConfig.graphScopes)
            .then(function (access_token) {
                
                var user = clientApplication.getUser();
                document.getElementById('logout_button').style.display = "block";
                document.getElementById('username').textContent = 'Signed in as: ' + user.displayableId;

                var xhr = new XMLHttpRequest();

                xhr.open('GET', 'https://graph.microsoft.com/v1.0/me', true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        document.getElementById('api_response').textContent = JSON.stringify(JSON.parse(xhr.responseText), null, '  ');
                    } else {
                        document.getElementById('api_response').textContent = 'ERROR:\n\n' + xhr.responseText;
                    }
                };

                xhr.send();
            }, function (error) {
                console.log(error);
                clientApplication.acquireTokenPopup(applicationConfig.graphScopes).then(function (access_token) {

                }, function (error) {
                    console.log(error);
                    document.getElementById('api_response').textContent = error;
                });
            });

            // document.getElementById('username').textContent = 'Not signed in.';
            // document.getElementById('login_button').style.display = "block";
        </script>
    </body>
</html>